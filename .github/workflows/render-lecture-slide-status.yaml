# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Source version of this workflow lives in https://github.com/slds-lmu/lecture_service
# Please only update by copying from there to avoid divergences
on:
  workflow_dispatch:
  push:
    branches: [main, master]
    # Probably makes most sense to only run this workflow when slides change
    # Also added the workflow itself to trigger a run if it changes
    # Comment out to run on every commit
    paths: ['slides/**', 'slides-pdf/*.pdf', '.github/workflows/render-lecture-slide-status.yaml']

name: render-lecture-slide-status

jobs:
  render-lecture-slide-status:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write # Required to be able to write to GitHub Pages branch
    steps:
      - name: Checkout this lecture repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Checkout service repo one directory level above
        run: |
          cd ..
          git clone --bare https://github.com/slds-lmu/lecture_service .git
          git config --unset core.bare
          git checkout


      # Uncomment / move to get a tmux ssh session for interactive debugging
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3

      # Standard R/pandoc/latex setup steps
      - uses: r-lib/actions/setup-pandoc@v2
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-tinytex@v2
      - run: tlmgr --version
      # Caching the R library requires to save its path beforehand, could hard-code but meh
      - name: Get R library dir for caching
        id: r-cache
        run: |
          echo "dir=$(Rscript --quiet -e 'cat(.libPaths()[[1]])')" >> $GITHUB_OUTPUT
      - name: Restore R package cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.r-cache.outputs.dir }}
          key: ${{ runner.os }}-r-${{inputs.cache-version }}-${{ hashFiles('scripts/install_r_deps.R') }}
          restore-keys: ${{ runner.os }}-r-${{inputs.cache-version }}-

      # Setting up the lecture checking requirements:
      - name: Install R, LaTeX packages and PDF tools
        working-directory: ".."
        run: |
          pwd
          make install-r
          make install-tex
          make install-tools-ubuntu

      # Run the main thing: compiles slides, checks against slides-pdf/*, renderes Rmd -> html site with results
      # Resulting output is in ./_site
      - name: Check slides and build HTML overview
        working-directory: ".."
        run: "pwd; make"

      # Deploy using this rather than JamesIves/github-pages-deploy-action, as this supports pushing
      # orphan branches. Since we're adding a bunch of PDFs, we really want to avoid a bloated branch history
      - name: Deploy to GitHub pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          force_orphan: true
